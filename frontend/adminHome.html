<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/css/uikit.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/js/uikit-icons.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Lexend+Deca:wght@100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="assets/css/uikitMods.css">
    <link rel="stylesheet" type="text/css" href="assets/css/tippyMods.css">
    <link rel = "stylesheet" type = "text/css" href = "https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.css">
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
</head>

<body>

    <div id = "topBar">
        <img id = "logo" src="assets/images/clear logo.png" alt="Humboldt Logo">
        <img id="pfp" style = "cursor:pointer" src="assets/images/pfp_test.jpg" alt="Profile Picture">
        <div uk-dropdown="pos: middle-right; mode: hover">
            <ul class="uk-nav uk-dropdown-nav">
                <li><a href="#" onclick="logOut()">Log Out</a></li>
            </ul>
        </div>
    </div>

    <div class="uk-card uk-card-default uk-card-body uk-box-shadow-large">

        
        <div id = "mainPage" class="uk-card-body">

            <!-- two tabbed interface-->
            <ul class="uk-tab" uk-tab>
                <li onclick = "changeTab('allScholarships')" style = "padding-left:20px;"><a href="#" class="active" id = "allTab">All Scholarships</a></li>
                <li onclick = "changeTab('myAdmins')"><a href="#" id = "adminsTab">All Admins</a></li>
                <li onclick = "changeTab('myProfile')"><a href="#" id = "myTab">My Profile</a></li>

                <!--search bar-->
                <input type="text" id="searchBar" onkeyup="searchScholarships()" placeholder="Search...">

            </ul>

            <div class = "page" id="allScholarships">

            <div class = "innerWriteable" id = "allScholarshipsInner">
                <!-- Scholarships will be loaded here dynamically -->
            </div>

            

            <div class = "innerToolbar">
                <button id = "createApplicationButton" onclick = "createScholarship()">
                    <i class="ri-add-fill"></i>
                    New Scholarship
                </button>
            </div>

            </div>

            <div class = "page" id="myAdmins">

            <div class = "innerWriteable" id = "myAdminsInner">
            </div>

            <div class = "innerToolbar">
                <button id = "createAccountButton" onclick = "createAdmin()">
                    <i class="ri-add-fill"></i>
                    New Admin
                </button>
            </div>


            </div>  

            <div class = "page" id="myProfile">
                <div class = "innerWriteable" id = "myProfileInner">
                    <h1>My Profile</h1>
                    <hr>
                    <div class = "profileInfo">
                        <b>First Name:</b> <span id = "myProfileFirstName">N/A</span><br>
                        <b>Last Name:</b> <span id = "myProfileLastName">N/A</span><br>
                        <b>Email:</b> <span id = "myProfileEmail">N/A</span><br>
                    </div>
                </div>

        </div>
    </div>

        <!-- Application Modal -->
        <div id="scholarshipCreateModal" uk-modal>
            <div class="uk-animation-fade">
                <div class="uk-width-large uk-margin-auto uk-card uk-card-default uk-card-body uk-box-shadow-large" style="width: 600px; margin-top: 0px;">
                    <form id="scholarshipForm">
                        <button type="button" class="closeButton" onclick="closeMenu('scholarshipCreateModal')">
                            <i class="ri-close-circle-fill"></i>
                        </button>
                        <h2 style="margin: 0px; margin-left: 0px; font-size: 25px; margin-bottom: -10px;" class="uk-text-left">New Scholarship</h2>
                        <hr style="border: 2px solid #e9e9e9;"/>

                        <div class="uk-margin">
                            <label class="uk-form-label" for="formScholarshipName">Scholarship Name</label>
                            <div class="uk-form-controls">
                                <input class="uk-input" id="formScholarshipName" type="text" placeholder="Scholarship Name">
                            </div>

                            <label class="uk-form-label" for="formScholarshipDueDate">Due Date</label>
                            <div class="uk-form-controls">
                                <input class="uk-input" id="formScholarshipDueDate" type="date" placeholder="Due Date">
                            </div>

                            <label class="uk-form-label" for="formScholarshipFunderName">Funder Name</label>
                            <div class="uk-form-controls">
                                <input class="uk-input" id="formScholarshipFunderName" type="text" placeholder="Funder Name">
                            </div>

                            <label class="uk-form-label" for="formScholarshipDescription">Description</label>
                            <div class="uk-form-controls">
                                <textarea class="uk-textarea" id="formScholarshipDescription" rows="5"
                                    placeholder="Description"></textarea>
                            </div>

                            <label class="uk-form-label" for="formScholarshipRequirements">Requirements</label>
                            <div class="uk-form-controls">
                                <textarea class="uk-textarea" id="formScholarshipRequirements" rows="5"
                                    placeholder="Requirements"></textarea>
                            </div>

                            <label class="uk-form-label" for="formScholarshipFundsAllocated">Funds Allocated</label>
                            <div class="uk-form-controls">
                                <input class="uk-input" id="formScholarshipFundsAllocated" type="number"
                                    placeholder="Funds Allocated">
                            </div>

    
                        <div class="uk-margin">
                            <button type="submit" class="uk-button uk-width-1-1" style="box-shadow:5px 5px 0px #33333350;border-radius:10px;font-size:16px;">
                                <i class="ri-check-fill" style="margin-right:5px"></i>
                                Create Scholarship
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!--Admin Creation Modal-->
        <div id="adminCreateModal" uk-modal>
            <div class="uk-animation-fade">
                <div class="uk-width-large uk-margin-auto uk-card uk-card-default uk-card-body uk-box-shadow-large" style="width: 600px; margin-top: 0px;">
                    <form id="adminForm">
                        <button type="button" class="closeButton" onclick="closeMenu('adminCreateModal')">
                            <i class="ri-close-circle-fill"></i>
                        </button>
                        <h2 style="margin: 0px; margin-left: 0px; font-size: 25px; margin-bottom: -10px;" class="uk-text-left">New Admin</h2>
                        <hr style="border: 2px solid #e9e9e9;"/>

                        <div class="uk-margin">

                            <label class="uk-form-label" for="formAdminEmail">Email</label>
                            <div class="uk-form-controls">
                                <input class="uk-input" id="formAdminEmail" type="email" placeholder="Email">
                            </div>
                        </div>

                        <!-- radio buttons for read or write permissions. one or the other-->
                        <div class="uk-margin">
                            <label class="uk-form-label">Permissions</label>
                            <div class="uk-form-controls">
                                <label><input class="uk-radio" type="radio" name="permissions" value="read" checked> Read</label><br>
                                <label><input class="uk-radio" type="radio" name="permissions" value="write"> Read/Write</label>
                            </div>
                        </div>
    
                        <div class="uk-margin">
                            <button type="submit" class="uk-button uk-width-1-1" style="box-shadow:5px 5px 0px #33333350;border-radius:10px;font-size:16px;">
                                <i class="ri-check-fill" style="margin-right:5px"></i>
                                Create Admin
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


</body>

<script src="assets/js/dummyScholarships.js"></script>

<script>

function getScholarshipData(id, menu) {
    const postedScholarship = document.getElementById(id);
    if (!postedScholarship) {
        console.error(`Element with ID ${id} not found.`);
        return;
    }

    const dataMappings = {
        name: "Name",
        creationDate: "Posted",
        funderName: "Funder",
        endDate: "EndDate",
        fundsAllocated: "Amount",
        requirements: "Requirements",
        description: "Description"
    };

    Object.keys(dataMappings).forEach(key => {
        const elemId = `${menu === "myScholarshipsMenu" ? "myScholarship" : "allScholarship"}${dataMappings[key]}`;
        const targetElem = document.getElementById(elemId);
        
        if (targetElem) {
            targetElem.innerHTML = postedScholarship.getAttribute(`data-${key}`) || "N/A";
        } else {
            console.warn(`Element with ID ${elemId} not found.`);
        }
    });

    if (menu === "allScholarshipsMenu") {
        const applyButton = document.getElementById('allApplyButton');
        if (applyButton) {
            applyButton.onclick = function () {
                UIkit.modal(document.getElementById('formSubmissionModal')).show();
                const descElem = document.getElementById('formScholarshipDesc');
                if (descElem) {
                    descElem.innerHTML = `<b style="font-weight:900">Description:</b> ${postedScholarship.getAttribute("data-description") || "N/A"}`;
                }
            };
        } else {
            console.warn("Apply button not found.");
        }
    }

    const menuElem = document.getElementById(menu);
    if (menuElem) {
        menuElem.style.display = "block";
    } else {
        console.warn(`Menu element with ID ${menu} not found.`);
    }
}

    function changeTab(tab) {
        ["allScholarships", "myAdmins", "myProfile"].forEach(id => {
            document.getElementById(id).style.display = id === tab ? "flex" : "none";
        });

        const tabMapping = {
            allScholarships: "allTab",
            myAdmins: "adminsTab",
            myProfile: "myTab"
        };

        ["allTab", "adminsTab", "myTab"].forEach(id => {
            document.getElementById(id).classList.toggle("active", id === tabMapping[tab]);
        });

        if (tab === "allScholarships") {
            document.getElementById('searchBar').style.display = "block";
        } else {
            document.getElementById('searchBar').style.display = "none";
        }

    }

    function closeMenu(menu){
        UIkit.modal(document.getElementById(menu)).hide();
    }

    window.onload = function(){

        //generateWriteScholarships("allScholarships");

        fetchScholarships();

        // Add submit handler for the scholarship form
        const scholarshipForm = document.getElementById('scholarshipForm');
        if (scholarshipForm) {
            scholarshipForm.addEventListener('submit', handleScholarshipSubmit);
            console.log('Scholarship form handler attached');
        } else {
            console.warn('Scholarship form not found');
        }
        
        // Add submit handler for the admin creation form
        const adminForm = document.getElementById('adminForm');
        if (adminForm) {
            adminForm.addEventListener('submit', handleAdminSubmit);
            console.log('Admin form handler attached');
        } else {
            console.warn('Admin form not found');
        }
            
    }
    
    function logOut(){
        localStorage.clear();
        window.location.href = "login.html";
    }

    function createScholarship(){
        // Clear any previous data and reset form
        const form = document.querySelector('#scholarshipCreateModal form');
        form.reset();
        document.getElementById('scholarshipCreateModal').removeAttribute('data-edit-id');
        
        const submitButton = document.querySelector('#scholarshipCreateModal form button');
        
        UIkit.modal(document.getElementById('scholarshipCreateModal')).show();
    }

    function createAdmin(){
        // Clear any previous data
        const form = document.querySelector('#adminCreateModal form');
        form.reset();
        
        UIkit.modal(document.getElementById('adminCreateModal')).show();
    }

    // Leave the detailed application view functions unchanged
    function showApplicationDetailsModal(application) {
        const submissionDate = new Date(application.dateSubmission).toLocaleDateString();
        const status = application.fundsDispursed ? 'Funds Disbursed' : 'Pending';
        
        // Format applicant name
        const applicantName = application.applicant ? 
            `${application.applicant.firstName} ${application.applicant.lastName}` : 'Unknown';
        
        // Create modal HTML
        let modalHTML = `
        <div id="applicationDetailsModal" uk-modal>
            <div class="uk-modal-dialog uk-modal-body">
                <button class="closeButton" type="button" uk-close onclick="document.getElementById('applicationDetailsModal').remove()"></button>
                <h2 class="uk-modal-title">Application Details</h2>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        UIkit.modal(document.getElementById('applicationDetailsModal')).show();
    }

// New function to fetch scholarships from the database
async function fetchScholarships() {
    try {
        document.getElementById('allScholarshipsInner').innerHTML = '<div class="uk-text-center"><div uk-spinner="ratio: 3"></div><p>Loading scholarships...</p></div>';
        
        const response = await fetch('/api/scholarships');
        
        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Fetched scholarships:', data); // Debug log
        
        // Clear loading indicator
        document.getElementById('allScholarshipsInner').innerHTML = '';
        
        // Display scholarships
        if (data.data && data.data.length > 0) {
            data.data.forEach(scholarship => {
                writeScholarshipFromDB(scholarship, "allScholarships");
            });
        } else {
            document.getElementById('allScholarshipsInner').innerHTML = '<p class="uk-text-center">No scholarships available at this time.</p>';
        }
    } catch (error) {
        console.error('Error fetching scholarships:', error);
        document.getElementById('allScholarshipsInner').innerHTML = `
            <div class="uk-alert-danger" uk-alert>
                <p>Error loading scholarships. Please try again later.</p>
                <p>Error details: ${error.message}</p>
            </div>
        `;
    }
}

// Function to write scholarships from database data
function writeScholarshipFromDB(scholarship, menu) {
    const randomID = "id_" + Math.floor(Math.random() * 1000000);
    
    // Convert database dates to JavaScript Date objects
    const dueDate = new Date(scholarship.dueDate);
    const creationDate = new Date(scholarship.creationDate);
    const endDate = new Date(scholarship.endDate);
    
    const fixedDateMonth = dueDate.getMonth() + 1;
    const fixedDateDay = dueDate.getDate();
    const fixedDateYear = dueDate.getFullYear();

    // Generate tooltip content
    const today = new Date();
    const timeDiff = dueDate.getTime() - today.getTime();
    const daysUntilDeadline = Math.ceil(timeDiff / (1000 * 3600 * 24));

    const postedDateMonth = creationDate.getMonth() + 1;
    const postedDateDay = creationDate.getDate();
    const postedDateYear = creationDate.getFullYear();

    // how many days ago was creation date
    var timeDiff2 = today.getTime() - creationDate.getTime();
    var daysSincePosted = Math.ceil(timeDiff2 / (1000 * 3600 * 24));

    // if it was "1 days ago" change to "yesterday"
    if (daysSincePosted === 1) {
        daysSincePosted = 'Posted yesterday';
    } else {
        daysSincePosted = daysSincePosted + ' days ago';
    }

    var formattedMoney = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
    }).format(scholarship.fundsAllocated);

    const tooltipContent = `
        <p>Full Description</p>
        <h3>${scholarship.description}</h3>
        <hr>
        <p style = 'margin-top:10px' >Full Requirements</p>
        <h3>${scholarship.requirements}</h3>
        <hr>
        <p>Quick Info</p>
        <b style = 'opacity:30%' ><i class='ri-price-tag-3-fill'></i></b> <span style = 'opacity:30%'>${scholarship.name}</span><br>
        <b style = 'opacity:30%' ><i class='ri-hand-coin-fill'></i></b> <span style = 'opacity:30%' >${scholarship.funderName}</span><br>
        <b><i class='ri-money-dollar-circle-line'></i></b> <span>${formattedMoney}<span><br>
        <b><i class='ri-award-line'></i></b> <span>${scholarship.fundingType || 'Scholarship'}</span><br>
        <b><i class='ri-group-2-line'></i></b> <span>${scholarship.numOfApps || 0} applicants</span><br>
        <b><i class='ri-calendar-check-line'></i></b> <span>${postedDateMonth}/${postedDateDay}/${postedDateYear}<span> <span class = 'daysLeft'> ${daysSincePosted}</span><br>
        <b><i class='ri-calendar-schedule-line'></i></b> <span>${fixedDateMonth}/${fixedDateDay}/${fixedDateYear}<span> <span class = 'daysLeft'> ${daysUntilDeadline} days left</span><br>
        <hr style = 'margin-top:10px;margin-bottom:10px'>
        <button class = 'applyButton2' onclick='editScholarship("${scholarship._id}")'>
        <i class='ri-edit-fill' style = 'margin-right:5px'></i>
        Edit Scholarship   
        </button>
        <button class = 'deleteButton' onclick='deleteScholarship("${scholarship._id}")' style="background-color: #ff5252; margin-top: 5px;">
        <i class='ri-delete-bin-line' style = 'margin-right:5px'></i>
        Delete
        </button>
        <button class = 'infoButton' onclick='viewApplications("${scholarship._id}")' style="background-color: #4CAF50; margin-top: 5px;">
        <i class='ri-file-list-line' style = 'margin-right:5px'></i>
        View Applications (${scholarship.applications ? scholarship.applications.length : 0})
        </button>
    `;

    const scholarshipHTML = `
    <div id="${randomID}" class="scholarship"
        data-id="${scholarship._id}"
        data-name="${scholarship.name}" 
        data-dueDate="${fixedDateMonth}/${fixedDateDay}"
        data-funderName="${scholarship.funderName}" 
        data-description="${scholarship.description}"
        data-fundsAllocated="${scholarship.fundsAllocated}" 
        data-fundingType="${scholarship.fundingType || 'Scholarship'}"
        data-numOfApps="${scholarship.numOfApps || 0}" 
        data-creationDate="${scholarship.creationDate}"
        data-endDate="${scholarship.endDate}" 
        data-requirements="${scholarship.requirements}"
        data-tippy-content="${tooltipContent}">
        <div class="scholarshipTitle">
            <div class="titleWrapper">
                <h1>${scholarship.name}</h1>
                <h2>${scholarship.funderName}</h2>
            </div>
            <h3><i style = "margin-right:5px;" class="ri-calendar-schedule-line"></i> ${fixedDateMonth}/${fixedDateDay}</h3>
        </div>
        <div class="scholarshipMiddle">
            <p>Description</p>
            <div class="scholarshipDesc">
            ${scholarship.description}
        </div>
    </div>`;

    document.getElementById(`${menu}Inner`).insertAdjacentHTML('beforeend', scholarshipHTML);

    // Initialize Tippy.js on the newly added scholarship after insertion
    setTimeout(() => {
        tippy(`#${randomID}`, {
            allowHTML: true,
            theme: 'innerMenuTheme',
            interactive: true,
            placement: 'right-start',
            inertia: true,
        });
    }, 0);  // Timeout ensures it's applied after the DOM is updated
}

// Make sure form submit handlers are properly implemented
function handleScholarshipSubmit(event) {
    event.preventDefault();
    console.log('Scholarship form submitted');
    
    // Validate form
    const name = document.getElementById('formScholarshipName').value;
    const dueDate = document.getElementById('formScholarshipDueDate').value;
    const funderName = document.getElementById('formScholarshipFunderName').value;
    
    if (!name || !dueDate || !funderName) {
        UIkit.notification({
            message: 'Please fill in all required fields',
            status: 'danger',
            pos: 'top-center',
            timeout: 3000
        });
        return;
    }
    
    // Prepare form data
    const formData = {
        name: name,
        dueDate: dueDate,
        funderName: funderName,
        description: document.getElementById('formScholarshipDescription').value || 'No description provided',
        requirements: document.getElementById('formScholarshipRequirements').value || 'No requirements specified',
        fundsAllocated: parseFloat(document.getElementById('formScholarshipFundsAllocated').value) || 0,
        fundingType: 'Scholarship', // Default value
        numOfApps: 0, // Default for new scholarships
        creationDate: new Date().toISOString(),
        endDate: dueDate, // Same as due date by default
    };
    
    const modal = document.getElementById('scholarshipCreateModal');
    const scholarshipId = modal.getAttribute('data-edit-id');
    const isUpdate = !!scholarshipId;
    
    const url = isUpdate ? `/api/scholarships/${scholarshipId}` : '/api/scholarships';
    const method = isUpdate ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Failed to ${isUpdate ? 'update' : 'create'} scholarship`);
        }
        return response.json();
    })
    .then(data => {
        UIkit.notification({
            message: `Scholarship ${isUpdate ? 'updated' : 'created'} successfully`,
            status: 'success',
            pos: 'top-center',
            timeout: 3000
        });
        
        // Reset form and close modal
        event.target.reset();
        UIkit.modal(modal).hide();
        
        // Reset modal state for next use
        modal.removeAttribute('data-edit-id');
        const submitButton = document.querySelector('#scholarshipCreateModal form button');
        submitButton.innerHTML = '<i class="ri-check-fill" style="margin-right:5px"></i>Create Scholarship';
        
        // Reload scholarships
        fetchScholarships();
    })
    .catch(error => {
        console.error('Error:', error);
        UIkit.notification({
            message: `Error ${isUpdate ? 'updating' : 'creating'} scholarship: ${error.message}`,
            status: 'danger',
            pos: 'top-center',
            timeout: 3000
        });
    });
}

function handleAdminSubmit(event) {
    event.preventDefault();
    console.log('Admin form submitted');
    
    // Validate password matching
    const password = document.getElementById('formAdminPassword').value;
    const confirmPassword = document.getElementById('formAdminPasswordConfirm').value;
    
    if (password !== confirmPassword) {
        UIkit.notification({
            message: 'Passwords do not match',
            status: 'danger',
            pos: 'top-center',
            timeout: 3000
        });
        return;
    }
    
    const formData = {
        firstName: document.getElementById('formAdminName').value,
        lastName: document.getElementById('formAdminLastName').value,
        email: document.getElementById('formAdminEmail').value,
        password: password,
        super: false, // Default values
        read: true,   // Default values
        write: true   // Default values
    };
    
    fetch('/api/admins', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to create admin account');
        }
        return response.json();
    })
    .then(data => {
        UIkit.notification({
            message: 'Admin account created successfully',
            status: 'success',
            pos: 'top-center',
            timeout: 3000
        });
        
        // Reset form and close modal
        event.target.reset();
        UIkit.modal(document.getElementById('adminCreateModal')).hide();
    })
    .catch(error => {
        console.error('Error:', error);
        UIkit.notification({
            message: `Error creating admin account: ${error.message}`,
            status: 'danger',
            pos: 'top-center',
            timeout: 3000
        });
    });
}

// Additional functions for scholarship management (edit, delete, view applications)
function editScholarship(scholarshipId) {
    fetch(`/api/scholarships/${scholarshipId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch scholarship details');
            }
            return response.json();
        })
        .then(data => {
            const scholarship = data.data;
            
            // Populate form fields
            document.getElementById('formScholarshipName').value = scholarship.name;
            document.getElementById('formScholarshipDueDate').value = new Date(scholarship.dueDate).toISOString().split('T')[0];
            document.getElementById('formScholarshipFunderName').value = scholarship.funderName;
            document.getElementById('formScholarshipDescription').value = scholarship.description;
            document.getElementById('formScholarshipRequirements').value = scholarship.requirements;
            document.getElementById('formScholarshipFundsAllocated').value = scholarship.fundsAllocated;
            
            // Store scholarship ID for the update operation
            document.getElementById('scholarshipCreateModal').setAttribute('data-edit-id', scholarshipId);
            
            // Change button text
            const submitButton = document.querySelector('#scholarshipCreateModal form button');
            submitButton.innerHTML = '<i class="ri-check-fill" style="margin-right:5px"></i>Update Scholarship';
            
            // Show modal
            UIkit.modal(document.getElementById('scholarshipCreateModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            UIkit.notification({
                message: 'Error loading scholarship details: ' + error.message,
                status: 'danger',
                pos: 'top-center',
                timeout: 3000
            });
        });
}

function deleteScholarship(scholarshipId) {
    if (confirm('Are you sure you want to delete this scholarship? This action cannot be undone.')) {
        const token = localStorage.getItem('token');
        
        fetch(`/api/scholarships/${scholarshipId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete scholarship');
            }
            return response.json();
        })
        .then(data => {
            UIkit.notification({
                message: 'Scholarship deleted successfully',
                status: 'success',
                pos: 'top-center',
                timeout: 3000
            });
            
            // Reload scholarships
            fetchScholarships();
        })
        .catch(error => {
            console.error('Error:', error);
            UIkit.notification({
                message: 'Error deleting scholarship: ' + error.message,
                status: 'danger',
                pos: 'top-center',
                timeout: 3000
            });
        });
    }
}

function viewApplications(scholarshipId) {
    // Implementation for viewing applications
    UIkit.notification({
        message: 'Application viewing not yet implemented',
        status: 'primary',
        pos: 'top-center',
        timeout: 3000
    });
}

function generateWriteScholarships(menu) {

for (let i = 0; i < dummyScholarships.length; i++) {
    writeScholarship(
        dummyScholarships[i].name,
        dummyScholarships[i].dueDate,
        dummyScholarships[i].funderName,
        dummyScholarships[i].description,
        dummyScholarships[i].fundsAllocated,
        dummyScholarships[i].fundingType,
        dummyScholarships[i].numOfApps,
        dummyScholarships[i].creationDate,
        dummyScholarships[i].endDate,
        dummyScholarships[i].requirements,
        menu
    );
}

}

function writeScholarship(
    name, dueDate, funderName, description, fundsAllocated, 
    fundingType, numOfApps, creationDate, endDate, requirements, menu
) {
    var randomID = "id_" + Math.floor(Math.random() * 1000000);
    const fixedDateMonth = dueDate.getMonth() + 1;
    const fixedDateDay = dueDate.getDate();
    const fixedDateYear = dueDate.getFullYear();

    // Generate tooltip content
    const today = new Date();
    const timeDiff = dueDate.getTime() - today.getTime();
    const daysUntilDeadline = Math.ceil(timeDiff / (1000 * 3600 * 24));

    const postedDateMonth = creationDate.getMonth() + 1;
    const postedDateDay = creationDate.getDate();
    const postedDateYear = creationDate.getFullYear();

    // how many days ago was creation date
    var timeDiff2 = today.getTime() - creationDate.getTime();
    var daysSincePosted = Math.ceil(timeDiff2 / (1000 * 3600 * 24));

    // if it was "1 days ago" change to "yesterday"
    if (daysSincePosted === 1) {
        daysSincePosted = 'Posted yesterday';
    } else {
        daysSincePosted = daysSincePosted + ' days ago';
    }

    var formattedMoney = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
    }).format(fundsAllocated);

    const tooltipContent = `
        <p>Full Description</p>
        <h3>${description}</h3>
        <hr>
        <p style = 'margin-top:10px' >Full Requirements</p>
        <h3>${requirements}</h3>
        <hr>
        <p>Quick Info</p>
        <b style = 'opacity:30%' ><i class='ri-price-tag-3-fill'></i></b> <span style = 'opacity:30%'>${name}</span><br>
        <b style = 'opacity:30%' ><i class='ri-hand-coin-fill'></i></b> <span style = 'opacity:30%' >${funderName}</span><br>
        <b><i class='ri-money-dollar-circle-line'></i></b> <span>${formattedMoney}<span><br>
        <b><i class='ri-award-line'></i></b> <span>${fundingType}</span><br>
        <b><i class='ri-calendar-check-line'></i></b> <span>${postedDateMonth}/${postedDateDay}/${postedDateYear}<span> <span class = 'daysLeft'> ${daysSincePosted}</span><br>
        <b><i class='ri-calendar-schedule-line'></i></b> <span>${fixedDateMonth}/${fixedDateDay}/${fixedDateYear}<span> <span class = 'daysLeft'> ${daysUntilDeadline} days left</span><br>
        <hr style = 'margin-top:10px;margin-bottom:10px'>
        <button class = 'applyButton2' onclick='launchApplyModal()'>
        <i class='ri-pencil-fill' style = 'margin-right:5px'></i>
        Edit Scholarship
        </button>
    `;

    const scholarshipHTML = `
    <div id="${randomID}" class="scholarship"
        data-name="${name}" 
        data-dueDate="${fixedDateMonth}/${fixedDateDay}"
        data-funderName="${funderName}" 
        data-description="${description}"
        data-fundsAllocated="${fundsAllocated}" 
        data-fundingType="${fundingType}"
        data-creationDate="${creationDate}"
        data-endDate="${endDate}"
        data-requirements="${requirements}"
        data-tippy-content="${tooltipContent}">
        <div class="scholarshipTitle">
            <div class="titleWrapper">
                <h1>${name}</h1>
                <h2>${funderName}</h2>
            </div>
            <h3><i style = "margin-right:5px;" class="ri-calendar-schedule-line"></i> ${fixedDateMonth}/${fixedDateDay}</h3>
        </div>
        <div class="scholarshipMiddle">
            <p>Requirements</p>
            <div class="scholarshipReq">${requirements}</div>
        </div>
    </div>`;

    document.getElementById(`${menu}Inner`).insertAdjacentHTML('beforeend', scholarshipHTML);

    // Initialize Tippy.js on the newly added scholarship after insertion
    setTimeout(() => {
        tippy(`#${randomID}`, {
            allowHTML: true,
            theme: 'innerMenuTheme',
            interactive: true,
            placement: 'right-start',
            intertia: true,
        });
    }, 0);  // Timeout ensures it's applied after the DOM is updated
}

function searchScholarships() {
    var input, filter, scholarships, scholarship, title, requirements, date, funder, description, i, txtValue, reqValue, dateValue, funderValue, descValue;
    input = document.getElementById("searchBar");
    filter = input.value.toUpperCase();
    scholarships = document.getElementById("allScholarshipsInner");
    scholarship = scholarships.getElementsByClassName("scholarship");
    for (i = 0; i < scholarship.length; i++) {
        title = scholarship[i].getElementsByTagName("h1")[0];
        requirements = scholarship[i].getElementsByClassName("scholarshipReq")[0];
        date = scholarship[i].getElementsByTagName("h3")[0];
        funder = scholarship[i].getElementsByTagName("h2")[0];
        description = scholarship[i].getElementsByClassName("scholarshipDesc")[0];
        txtValue = title ? (title.textContent || title.innerText) : "";
        reqValue = requirements ? (requirements.textContent || requirements.innerText) : "";
        dateValue = date ? (date.textContent || date.innerText) : "";
        funderValue = funder ? (funder.textContent || funder.innerText) : "";
        descValue = description ? (description.textContent || description.innerText) : "";
        if (txtValue.toUpperCase().indexOf(filter) > -1 || reqValue.toUpperCase().indexOf(filter) > -1 || dateValue.toUpperCase().indexOf(filter) > -1 || funderValue.toUpperCase().indexOf(filter) > -1 || descValue.toUpperCase().indexOf(filter) > -1) {
            scholarship[i].style.display = "";
        } else {
            scholarship[i].style.display = "none";
        }
    }
}



</script>

</html>