<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/css/uikit.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/js/uikit-icons.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Lexend+Deca:wght@100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="assets/css/uikitMods.css">
    <link rel="stylesheet" type="text/css" href="assets/css/tippyMods.css">
    <link rel = "stylesheet" type = "text/css" href = "https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.css">
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
</head>

<body>

    <div id="topBar">
        <img id="logo" src="assets/images/clear logo.png" alt="Humboldt Logo">
        <img id="pfp" style = "cursor:pointer" src="assets/images/pfp_test.jpg" alt="Profile Picture">
        <div uk-dropdown="pos: middle-right; mode: hover">
            <ul class="uk-nav uk-dropdown-nav">
                <li><a href="#" onclick="logOut()">Log Out</a></li>
            </ul>
        </div>
    </div>

    <div class="uk-card uk-card-default uk-card-body uk-box-shadow-large">
        <div id="mainPage" class="uk-card-body">

            <!-- Tab Navigation -->
            <ul class="uk-tab" uk-tab>
                <li style = "margin-left:10px" onclick="changeTab('allScholarships')"><a href="#" id="allTab" class="active">
                    <i class="ri-compass-line"></i>
                    All Scholarships</a>
                </li>
                <li onclick="changeTab('myScholarships')"><a href="#" id="myTab">
                    <i class="ri-history-fill"></i>
                    My Scholarships</a></li>
                <li style = "margin-right:10px" onclick="changeTab('myProfile')"><a href="#" id="pfTab">
                    <i class="ri-user-3-fill"></i>
                    My Profile</a></li>
            </ul>

            <!-- Scholarship Pages -->
            <div class="page" id="allScholarships">
                <div class="innerWriteable" id="allScholarshipsInner"></div>
            </div>

            <div class="page" id="myScholarships">
                <div class="innerWriteable" id="myScholarshipsInner"></div>
            </div>
            <div class="page" id = "myProfileOuter">
                <div id="myProfile" class="uk-flex uk-flex-middle uk-animation-fade" uk-height-viewport>

                                        
                                        <div id="myProfileInner">
    
            
                                            <form id="profileForm">
                                                <div class="uk-grid-small uk-child-width-1-3@m" uk-grid>
                                                    
                                                    <!-- Column 1 -->
                                                    <div>
                                                        <div class="uk-margin">
                                                            <label class="uk-form-label">Upload Profile Picture</label>
                                                            <div uk-form-custom="target: true">
                                                                <input type="file" id="profilePic" name="pic" accept="image/*" required>
                                                                <input class="uk-input uk-form-width-medium" type="text" placeholder="Select file" disabled>
                                                            </div>
                                                        </div>
                                            
                                                        <div class="uk-inline uk-width-1-1">
                                                            <span class="uk-form-icon" uk-icon="icon: mail"></span>
                                                            <input class="uk-input" type="email" placeholder="example@domain.com" required>
                                                        </div>
                                            
                                                        <div class="uk-margin">
                                                            <div class="uk-inline uk-width-1-1">
                                                                <span class="uk-form-icon" uk-icon="icon: phone"></span>
                                                                <input class="uk-input" type="tel" placeholder="(888) 888-8888" required>
                                                            </div>
                                                        </div>
                                            
                                                        <div class="uk-inline uk-width-1-1">
                                                            <span class="uk-form-icon" uk-icon="icon: home"></span>
                                                            <input class="uk-input" type="text" placeholder="Street Address 1" required>
                                                        </div>
                                            
                                                        <div class="uk-inline uk-width-1-1">
                                                            <span class="uk-form-icon" uk-icon="icon: home"></span>
                                                            <input class="uk-input" type="text" placeholder="Street Address 2">
                                                        </div>
                                                    </div>
                                            
                                                    <!-- Column 2 -->
                                                    <div>
                                                        <div class="uk-margin">
                                                            <div class="uk-inline uk-width-1-3">
                                                                <input class="uk-input" type="text" placeholder="City" required>
                                                            </div>
                                                            <div class="uk-inline uk-width-1-4">
                                                                <input class="uk-input" type="text" placeholder="State" required>
                                                            </div>
                                                            <div class="uk-inline uk-width-1-3">
                                                                <input class="uk-input" type="text" placeholder="ZIP" required>
                                                            </div>
                                                        </div>
                                            
                                                        <div class="uk-inline uk-width-1-1">
                                                            <span class="uk-form-icon" uk-icon="icon: location"></span>
                                                            <input class="uk-input" type="text" placeholder="High School" required>
                                                        </div>
                                            
                                                        <div class="uk-inline uk-width-1-1">
                                                            <span class="uk-form-icon" uk-icon="icon: star"></span>
                                                            <input class="uk-input" type="text" placeholder="GPA (Optional)">
                                                        </div>
                                            
                                                        <div class="uk-inline uk-width-1-1">
                                                            <span class="uk-form-icon" uk-icon="icon: location"></span>
                                                            <input class="uk-input" type="text" placeholder="College/University" required>
                                                        </div>
                                            
                                                        <div class="uk-inline uk-width-1-1">
                                                            <span class="uk-form-icon" uk-icon="icon: pencil"></span>
                                                            <input class="uk-input" type="text" placeholder="Major" required>
                                                        </div>
                                                    </div>
                                            
                                                    <!-- Column 3 -->
                                                    <div>
                                                        <div class="uk-inline uk-width-1-1">
                                                            <span class="uk-form-icon" uk-icon="icon: star"></span>
                                                            <input class="uk-input" type="text" placeholder="GPA" required>
                                                        </div>
                                            
                                                        <div class="uk-margin">
                                                            <label class="uk-form-label">Upload Transcripts</label>
                                                            <div uk-form-custom="target: true">
                                                                <input type="file" id="transcriptsFile" name="transcripts" accept=".pdf,.doc,.docx,image/*" required>
                                                                <input class="uk-input uk-form-width-medium" type="text" placeholder="Select file" disabled>
                                                            </div>
                                                            
                                                        </div>
                                            
                                                        <div class="uk-inline uk-width-1-1">
                                                            <label class="uk-form-label">Year</label>
                                                            <select class="uk-select" id="studentType" required>
                                                                <option value="" selected disabled>Select...</option>
                                                                <option value="freshman">Freshman</option>
                                                                <option value="sophomore">Sophomore</option>
                                                                <option value="junior">Junior</option>
                                                                <option value="senior">Senior</option>
                                                            </select>
                                                        </div>
                                            
                                                        <div class="uk-margin">
                                                            <label class="uk-form-label">Enrollment Status</label>
                                                            <select class="uk-select" id="enrollmentStatus" required>
                                                                <option value="" selected disabled>Select...</option>
                                                                <option value="part-time">Part-time</option>
                                                                <option value="full-time">Full-time</option>
                                                            </select>
                                                        </div>
                                            
                                                        <div class="uk-margin">
                                                            <div class="uk-inline uk-width-1-1">
                                                                <span class="uk-form-icon" uk-icon="icon: calendar"></span>
                                                                <input class="uk-input" type="text" placeholder="Expected Graduation Date (YYYY)" required>
                                                            </div>
                                                        </div>
                                                    </div>
                                            
                                                </div>
                                            
                                                <!-- Password Fields -->
                                                <div class="uk-margin uk-width-1-1" style="white-space:nowrap">
                                                    <div class="uk-inline uk-width-1-2">
                                                        <span class="uk-form-icon" uk-icon="icon: lock"></span>
                                                        <input class="uk-input" id="password" type="password" placeholder="Password" required>
                                                    </div>
                                                    <div class="uk-inline uk-width-1-2">
                                                        <span class="uk-form-icon" uk-icon="icon: lock"></span>
                                                        <input class="uk-input" id="confirmPassword" type="password" placeholder="Confirm Password" required>
                                                    </div>
                                                </div>
                                            
                                                <!-- Error Message -->
                                                <div id="error-message" class="uk-text-danger uk-text-center" style="display: none;"></div>
                                            
                                                <!-- Save Button -->
                                                <div class="uk-margin">
                                                    <button type="submit" class="uk-button uk-width-1-1">Save Changes</button>
                                                </div>
                                            
                                            </form>
                                        </div> <!-- End #myprofileinner -->
                                
                </div>
            </div>
            
            <script>
            function enableEdit(button) {
                let input = button.previousElementSibling;
                if (input.tagName === "SELECT" || input.type === "file") {
                    input.disabled = false;
                } else {
                    input.removeAttribute("disabled");
                }
                button.style.display = 'none';
                button.nextElementSibling.style.display = 'inline-block';
            }
            
            function saveEdit(button) {
                let input = button.previousElementSibling.previousElementSibling;
                if (input.tagName === "SELECT" || input.type === "file") {
                    input.disabled = true;
                } else {
                    input.setAttribute("disabled", "disabled");
                }
                button.style.display = 'none';
                button.previousElementSibling.style.display = 'inline-block';
            }
            </script>
    </div>

    <!-- Application Modal -->
    <div id="formSubmissionModal" uk-modal>
        <div class="uk-animation-fade">
            <div class="uk-width-large uk-margin-auto uk-card uk-card-default uk-card-body uk-box-shadow-large" style="    width: 600px;
    margin-top: 0px;">
                <form id="applicationForm">
                    <button class="closeButton" type="button" onclick="closeMenu('formSubmissionModal')">
                        <i class="ri-close-circle-fill"></i>
                    </button>
                    <h2 style = "
                    margin: 10px;
                    margin-left: 0px;
                    " class="uk-text-left">Scholarship Application</h2>
                    <hr />
                    <input type="hidden" id="scholarshipId" name="scholarshipId">

                    <div class="uk-margin">
                        <textarea id="personalStatement" class="uk-textarea" name="personalStatement" placeholder="Include a personal statement (max. 500)" maxlength="500" required></textarea>
                    </div>

                    <div class="uk-inline uk-width-1-1">
                        <label class="uk-form-label">Upload Cover Letter</label>
                        <div uk-form-custom="target: true">
                            <input type="file" id="cvFile" name="cv" accept=".pdf,.doc,.docx" required>
                            <input class="uk-input uk-form-width-medium" type="text" placeholder="Select file" disabled>
                        </div>
                    </div>

                    <p class="formWarning">
                        <i class="ri-information-line"></i>
                    Your transcripts will be automatically submitted with this application.
                </p>

                    <div class="uk-margin">
                        <button onclick = "submitApplication_test()" type="submit" class="uk-button uk-width-1-1" style = "box-shadow:5px 5px 0px #33333350;border-radius:10px">
                            <i class="ri-check-fill" style = "margin-right:5px"></i>
                        Submit Application
                    </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!--Editing Profile Modal-->
    <div id="editProfileModal" uk-modal>
    <div class="uk-modal-dialog uk-modal-body">
        <button class="closeButton" onclick="closeMenu('editProfileModal')">
            <i class="ri-close-circle-fill"></i>
        </button>
        <h2 style = "
        margin: 10px;
        margin-left: 0px;
        " class="uk-text-left">Edit Profile</h2>
        <hr />
        
        <form>
            <div class="form-container uk-column-1-2 uk-column-divider">
                <div id="column-left">
                    <div class="uk-margin">
                        <div class="uk-inline uk-width-1-1">
                            <label class="uk-form-label">Upload Profile Picture</label>
                            <br />
                            <div uk-form-custom="target: true">
                                <input type="file" required="required">
                                <input class="uk-input uk-form-width-medium" type="text" placeholder="Select file" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="uk-inline uk-width-1-1">
                        <span class="uk-form-icon" uk-icon="icon: mail"></span>
                        <input class="uk-input" type="email" placeholder="example@domain.com" required="required">
                    </div>
                    <div class="uk-margin">
                        <div class="uk-inline uk-width-1-1">
                            <span class="uk-form-icon" uk-icon="icon: phone"></span>
                            <input class="uk-input" type="tel" placeholder="(888) 888-8888" required="required">
                        </div>
                    </div>
                    <div class="uk-inline uk-width-1-1" style="margin-bottom:5px">
                        <span class="uk-form-icon" uk-icon="icon: home"></span>
                        <input class="uk-input" type="text" placeholder="Street Address 1" required="required">
                    </div>
                    <div class="uk-inline uk-width-1-1" style="margin-bottom:5px">
                        <span class="uk-form-icon" uk-icon="icon: home"></span>
                        <input class="uk-input" type="text" placeholder="Street Address 2">
                    </div>
                    <div>
                        <div class="uk-inline uk-width-1-3">
                            <input class="uk-input" type="text" placeholder="City" required="required">
                        </div>
                        <div class="uk-inline uk-width-1-4">
                            <input class="uk-input" type="text" placeholder="State" required="required">
                        </div>
                        <div class="uk-inline uk-width-1-3">
                            <input class="uk-input" type="text" placeholder="ZIP" required="required">
                        </div>
                    </div>
                    <br />
                    <div class="uk-margin">
                        <div class="uk-inline uk-width-1-1" style="margin-bottom:5px">
                            <span class="uk-form-icon" uk-icon="icon: location"></span>
                            <input class="uk-input" type="text" placeholder="High School" required="required">
                        </div>
                        <div class="uk-inline uk-width-1-1">
                            <span class="uk-form-icon" uk-icon="icon: star"></span>
                            <input class="uk-input" type="text" placeholder="GPA (Optional)">
                        </div>
                    </div>
                </div>
                <div id="column-right">
                    <div class="uk-inline uk-width-1-1" style="margin-bottom:5px">
                        <span class="uk-form-icon" uk-icon="icon: location"></span>
                        <input class="uk-input" type="text" placeholder="College/University" required="required">
                    </div>
                    <div class="uk-inline uk-width-1-1" style="margin-bottom:5px">
                        <span class="uk-form-icon" uk-icon="icon: pencil"></span>
                        <input class="uk-input" type="text" placeholder="Major" required="required">
                    </div>
                    <div class="uk-inline uk-width-1-1" style="margin-bottom:5px">
                        <span class="uk-form-icon" uk-icon="icon: star"></span>
                        <input class="uk-input" type="text" placeholder="GPA" required="required">
                    </div>
                    <div class="uk-margin">
                        <div class="uk-inline uk-width-1-1">
                            <label class="uk-form-label">Upload Transcripts</label>
                            <br />
                            <div uk-form-custom="target: true">
                                <input type="file" id="transcriptsFile" name="transcripts" accept=".pdf,.doc,.docx,image/*" required="required">
                                <input class="uk-input uk-form-width-medium" type="text" placeholder="Select file" disabled>
                            </div>
                            
                        </div>
                    </div>
                    <div class="uk-inline uk-width-1-1">
                        <label class="uk-form-label">Year</label>
                        <select class="uk-select" id="studentType" required="required">
                            <option value="" selected disabled>Select...</option>
                            <option value="freshman">Freshman</option>
                            <option value="sophomore">Sophomore</option>
                            <option value="junior">Junior</option>
                            <option value="senior">Senior</option>
                        </select>
                    </div>
                    <div class="uk-margin">
                        <div class="uk-inline uk-width-1-1">
                            <label class="uk-form-label">Enrollment Status</label>
                            <select class="uk-select" id="enrollmentStatus" required="required">
                                <option value="" selected disabled>Select...</option>
                                <option value="part-time">Part-time</option>
                                <option value="full-time">Full-time</option>
                            </select>
                        </div>
                    </div>
                    <div class="uk-margin">
                        <div class="uk-inline uk-width-1-1">
                            <span class="uk-form-icon" uk-icon="icon: calendar"></span>
                            <input class="uk-input" type="text" placeholder="Expected Graduation Date (YYYY)" required="required">
                        </div>
                    </div>
                </div>
            </div>
            <div class="uk-margin uk-width-1-1" style="white-space:nowrap">
                <div class="uk-inline uk-width-1-2">
                    <span class="uk-form-icon" uk-icon="icon: lock"></span>
                    <input class="uk-input" id="password" type="password" placeholder="Password" required="required">
                </div>
                <div class="uk-inline uk-width-1-2">
                    <span class="uk-form-icon" uk-icon="icon: lock"></span>
                    <input class="uk-input" id="confirmPassword" type="password" placeholder="Confirm Password" required="required">
                </div>
            </div>
            <div id="error-message" class="uk-text-danger uk-text-center" style="display: none;"></div>
            <div class="uk-margin">
                <button type="submit" class="uk-button uk-width-1-1">Save Changes</button>
            </div>
        </form>
    </div>
</body>

<script src="assets/js/dummyScholarships.js"></script>

<script>


function writeScholarship(
    name, dueDate, funderName, description, fundsAllocated, 
    fundingType, numOfApps, creationDate, endDate, requirements, menu
) {
    var randomID = "id_" + Math.floor(Math.random() * 1000000);
    const fixedDateMonth = dueDate.getMonth() + 1;
    const fixedDateDay = dueDate.getDate();
    const fixedDateYear = dueDate.getFullYear();

    // Generate tooltip content
    const today = new Date();
    const timeDiff = dueDate.getTime() - today.getTime();
    const daysUntilDeadline = Math.ceil(timeDiff / (1000 * 3600 * 24));

    const postedDateMonth = creationDate.getMonth() + 1;
    const postedDateDay = creationDate.getDate();
    const postedDateYear = creationDate.getFullYear();

    // how many days ago was creation date
    var timeDiff2 = today.getTime() - creationDate.getTime();
    var daysSincePosted = Math.ceil(timeDiff2 / (1000 * 3600 * 24));

    // if it was "1 days ago" change to "yesterday"
    if (daysSincePosted === 1) {
        daysSincePosted = 'Posted yesterday';
    } else {
        daysSincePosted = daysSincePosted + ' days ago';
    }

    var formattedMoney = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
    }).format(fundsAllocated);

    const tooltipContent = `
        <p>Full Description</p>
        <h3>${description}</h3>
        <hr>
        <p style = 'margin-top:10px' >Full Requirements</p>
        <h3>${requirements}</h3>
        <hr>
        <p>Quick Info</p>
        <b style = 'opacity:30%' ><i class='ri-price-tag-3-fill'></i></b> <span style = 'opacity:30%'>${name}</span><br>
        <b style = 'opacity:30%' ><i class='ri-hand-coin-fill'></i></b> <span style = 'opacity:30%' >${funderName}</span><br>
        <b><i class='ri-money-dollar-circle-line'></i></b> <span>${formattedMoney}<span><br>
        <b><i class='ri-award-line'></i></b> <span>${fundingType}</span><br>
        <b><i class='ri-calendar-check-line'></i></b> <span>${postedDateMonth}/${postedDateDay}/${postedDateYear}<span> <span class = 'daysLeft'> ${daysSincePosted}</span><br>
        <b><i class='ri-calendar-schedule-line'></i></b> <span>${fixedDateMonth}/${fixedDateDay}/${fixedDateYear}<span> <span class = 'daysLeft'> ${daysUntilDeadline} days left</span><br>
        <hr style = 'margin-top:10px;margin-bottom:10px'>
        <button class = 'applyButton2' onclick='launchApplyModal()'>
        <i class='ri-external-link-fill' style = 'margin-right:5px'></i>
        Apply Now
        </button>
    `;

    const scholarshipHTML = `
    <div id="${randomID}" class="scholarship"
        data-name="${name}" 
        data-dueDate="${fixedDateMonth}/${fixedDateDay}"
        data-funderName="${funderName}" 
        data-description="${description}"
        data-fundsAllocated="${fundsAllocated}" 
        data-fundingType="${fundingType}"
        data-creationDate="${creationDate}"
        data-endDate="${endDate}" 
        data-requirements="${requirements}"
        data-tippy-content="${tooltipContent}">
        <div class="scholarshipTitle">
            <div class="titleWrapper">
                <h1>${name}</h1>
                <h2>${funderName}</h2>
            </div>
            <h3><i style = "margin-right:5px;" class="ri-calendar-schedule-line"></i> ${fixedDateMonth}/${fixedDateDay}</h3>
        </div>
        <div class="scholarshipMiddle">
            <p>Requirements</p>
            <div class="scholarshipReq">${requirements}</div>
        </div>
    </div>`;

    document.getElementById(`${menu}Inner`).insertAdjacentHTML('beforeend', scholarshipHTML);

    // Initialize Tippy.js on the newly added scholarship after insertion
    setTimeout(() => {
        tippy(`#${randomID}`, {
            allowHTML: true,
            theme: 'innerMenuTheme',
            interactive: true,
            placement: 'right-start',
            intertia: true,
            onShow(instance) {
                // selected_ID = the id of the scholarship that was clicked
                selected_ID = instance.reference.id;
            }
        });
    }, 0);  // Timeout ensures it's applied after the DOM is updated
}

    function getScholarshipData(id, menu) {
    const postedScholarship = document.getElementById(id);
    if (!postedScholarship) {
        console.error(`Element with ID ${id} not found.`);
        return;
    }

    // Fix for mapping scholarship data to UI elements
    const dataMappings = {
        name: "Name",
        creationDate: "Posted",
        funderName: "Funder",
        endDate: "EndDate",
        fundsAllocated: "Amount",
        requirements: "Requirements",
        description: "Description"
    };

    // Convert MongoDB _id to string if needed
    const scholarshipId = postedScholarship.getAttribute('data-id') || id;

    // Either use existing element data or fetch from API if needed
    Object.keys(dataMappings).forEach(key => {
        const elemId = `${menu === "myScholarshipsMenu" ? "myScholarship" : "allScholarship"}${dataMappings[key]}`;
        const targetElem = document.getElementById(elemId);
        
        if (targetElem) {
            targetElem.innerHTML = postedScholarship.getAttribute(`data-${key}`) || "N/A";
        } else {
            console.warn(`Element with ID ${elemId} not found.`);
        }
    });

    if (menu === "allScholarshipsMenu") {
        const applyButton = document.getElementById('allApplyButton');
        if (applyButton) {
            applyButton.onclick = function () {
                UIkit.modal(document.getElementById('formSubmissionModal')).show();
                const descElem = document.getElementById('formScholarshipDesc');
                if (descElem) {
                    descElem.innerHTML = `<b style="font-weight:900">Description:</b> ${postedScholarship.getAttribute("data-description") || "N/A"}`;
                }
            };
        } else {
            console.warn("Apply button not found.");
        }
    }

    const menuElem = document.getElementById(menu);
    if (menuElem) {
        menuElem.style.display = "block";
    } else {
        console.warn(`Menu element with ID ${menu} not found.`);
    }
}

    // New function to fetch scholarships from the API
    async function fetchScholarships() {
        try {
            document.getElementById('allScholarshipsInner').innerHTML = '<div class="uk-text-center"><div uk-spinner="ratio: 3"></div><p>Loading scholarships...</p></div>';
            
            const response = await fetch('/api/scholarships');
            
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error('Failed to retrieve scholarships');
            }
            
            // Clear loading indicator
            document.getElementById('allScholarshipsInner').innerHTML = '';
            
            // Display scholarships
            if (data.data && data.data.length > 0) {
                data.data.forEach(scholarship => {
                    writeScholarshipFromDB(scholarship, "allScholarships");
                });
            } else {
                document.getElementById('allScholarshipsInner').innerHTML = '<p class="uk-text-center">No scholarships available at this time.</p>';
            }
        } catch (error) {
            console.error('Error fetching scholarships:', error);
            document.getElementById('allScholarshipsInner').innerHTML = `
                <div class="uk-alert-danger" uk-alert>
                    <p>Error loading scholarships. Please try again later.</p>
                </div>
            `;
        }
    }

    // New function to fetch user's applied scholarships
    async function fetchMyScholarships() {
        try {
            document.getElementById('myScholarshipsInner').innerHTML = '<div class="uk-text-center"><div uk-spinner="ratio: 3"></div><p>Loading your scholarships...</p></div>';
            
            // You'll need to implement this API endpoint
            const response = await fetch('/api/applications/user');
            
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            
            const data = await response.json();
            
            document.getElementById('myScholarshipsInner').innerHTML = '';
            
            if (data.data && data.data.length > 0) {
                data.data.forEach(application => {
                    // Assuming the API returns scholarship data with each application
                    writeScholarshipFromDB(application.scholarship, "myScholarships");
                });
            } else {
                document.getElementById('myScholarshipsInner').innerHTML = '<p class="uk-text-center">You haven\'t applied to any scholarships yet.</p>';
            }
        } catch (error) {
            console.error('Error fetching your scholarships:', error);
            document.getElementById('myScholarshipsInner').innerHTML = `
                <div class="uk-alert-danger" uk-alert>
                    <p>Error loading your scholarships. Please try again later.</p>
                </div>
            `;
        }
    }

    function generateWriteScholarships(menu) {

for (let i = 0; i < dummyScholarships.length; i++) {
    writeScholarship(
        dummyScholarships[i].name,
        dummyScholarships[i].dueDate,
        dummyScholarships[i].funderName,
        dummyScholarships[i].description,
        dummyScholarships[i].fundsAllocated,
        dummyScholarships[i].fundingType,
        dummyScholarships[i].numOfApps,
        dummyScholarships[i].creationDate,
        dummyScholarships[i].endDate,
        dummyScholarships[i].requirements,
        menu
    );
}

}



    // Function to write scholarships from database data
    function writeScholarshipFromDB(scholarship, menu) {
        const randomID = "id_" + Math.floor(Math.random() * 1000000);
        
        // Convert database dates to JavaScript Date objects
        const dueDate = new Date(scholarship.dueDate);
        const creationDate = new Date(scholarship.creationDate);
        const endDate = new Date(scholarship.endDate);
        
        const fixedDateMonth = dueDate.getMonth() + 1;
        const fixedDateDay = dueDate.getDate();
        const fixedDateYear = dueDate.getFullYear();

        // Generate tooltip content
        const today = new Date();
        const timeDiff = dueDate.getTime() - today.getTime();
        const daysUntilDeadline = Math.ceil(timeDiff / (1000 * 3600 * 24));

        const postedDateMonth = creationDate.getMonth() + 1;
        const postedDateDay = creationDate.getDate();
        const postedDateYear = creationDate.getFullYear();

        // how many days ago was creation date
        var timeDiff2 = today.getTime() - creationDate.getTime();
        var daysSincePosted = Math.ceil(timeDiff2 / (1000 * 3600 * 24));

        // if it was "1 days ago" change to "yesterday"
        if (daysSincePosted === 1) {
            daysSincePosted = 'Posted yesterday';
        } else {
            daysSincePosted = daysSincePosted + ' days ago';
        }

        var formattedMoney = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
        }).format(scholarship.fundsAllocated);

        const tooltipContent = `
            <p>Full Description</p>
            <h3>${scholarship.description}</h3>
            <hr>
            <p style = 'margin-top:10px' >Full Requirements</p>
            <h3>${scholarship.requirements}</h3>
            <hr>
            <p>Quick Info</p>
            <b style = 'opacity:30%' ><i class='ri-price-tag-3-fill'></i></b> <span style = 'opacity:30%'>${scholarship.name}</span><br>
            <b style = 'opacity:30%' ><i class='ri-hand-coin-fill'></i></b> <span style = 'opacity:30%' >${scholarship.funderName}</span><br>
            <b><i class='ri-money-dollar-circle-line'></i></b> <span>${formattedMoney}<span><br>
            <b><i class='ri-award-line'></i></b> <span>${scholarship.fundingType}</span><br>
            <b><i class='ri-group-2-line'></i></b> <span>${scholarship.numOfApps} applicants</span><br>
            <b><i class='ri-calendar-check-line'></i></b> <span>${postedDateMonth}/${postedDateDay}/${postedDateYear}<span> <span class = 'daysLeft'> ${daysSincePosted}</span><br>
            <b><i class='ri-calendar-schedule-line'></i></b> <span>${fixedDateMonth}/${fixedDateDay}/${fixedDateYear}<span> <span class = 'daysLeft'> ${daysUntilDeadline} days left</span><br>
            <hr style = 'margin-top:10px;margin-bottom:10px'>
            <button class = 'applyButton2' onclick='launchApplyModal()'>
            <i class='ri-external-link-fill' style = 'margin-right:5px'></i>
            Apply Now
            </button>
        `;

        const scholarshipHTML = `
        <div id="${randomID}" class="scholarship"
            data-id="${scholarship._id}"
            data-name="${scholarship.name}" 
            data-dueDate="${fixedDateMonth}/${fixedDateDay}"
            data-funderName="${scholarship.funderName}" 
            data-description="${scholarship.description}"
            data-fundsAllocated="${scholarship.fundsAllocated}" 
            data-fundingType="${scholarship.fundingType}"
            data-numOfApps="${scholarship.numOfApps}" 
            data-creationDate="${scholarship.creationDate}"
            data-endDate="${scholarship.endDate}" 
            data-requirements="${scholarship.requirements}"
            data-tippy-content="${tooltipContent}">
            <div class="scholarshipTitle">
                <div class="titleWrapper">
                    <h1>${scholarship.name}</h1>
                    <h2>${scholarship.funderName}</h2>
                </div>
                <h3><i style = "margin-right:5px;" class="ri-calendar-schedule-line"></i> ${fixedDateMonth}/${fixedDateDay}</h3>
            </div>
            <div class="scholarshipMiddle">
                <p>Requirements</p>
                <div class="scholarshipReq">${scholarship.requirements}</div>
            </div>
        </div>`;

        document.getElementById(`${menu}Inner`).insertAdjacentHTML('beforeend', scholarshipHTML);

        // Initialize Tippy.js on the newly added scholarship after insertion
        setTimeout(() => {
            tippy(`#${randomID}`, {
                allowHTML: true,
                theme: 'innerMenuTheme',
                interactive: true,
                placement: 'right-start',
                inertia: true,
            });
        }, 0);  // Timeout ensures it's applied after the DOM is updated
    }

    function changeTab(tab) {
        ["allScholarships", "myScholarships", "myProfile"].forEach(id => {
            document.getElementById(id).style.display = id === tab ? "flex" : "none";
        });

        const tabMapping = {
            allScholarships: "allTab",
            myScholarships: "myTab",
            myProfile: "pfTab"
        };

        ["allTab", "myTab", "pfTab"].forEach(id => {
            document.getElementById(id).classList.toggle("active", id === tabMapping[tab]);
        });
        
        // Load tab-specific data when switching tabs
        if (tab === "myScholarships") {
            //fetchMyScholarships();
        }

        if (tab === "myProfile") {
            document.getElementById('myProfileOuter').style.backgroundImage = "none";
        } else {
            document.getElementById('myProfileOuter').style.backgroundImage = "url('assets/images/pfp_test.jpg')";
        }

    }

    function logOut() {
        localStorage.clear();
        window.location.href = "login.html";
    }

    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    // Update window.onload to fetch real data instead of using dummy data
    window.onload = () => {

        //fetchScholarships();
        
        // Check for and display any URL parameters or notifications
        /*const urlParams = new URLSearchParams(window.location.search);
        const message = urlParams.get('message');
        if (message) {
            UIkit.notification({
                message: message,
                status: 'primary',
                pos: 'top-center',
                timeout: 5000
            });
        }
            */

            generateWriteScholarships("allScholarships");
    };

    function closeMenu(menu) {
        UIkit.modal(document.getElementById(menu)).hide();
        
    }

    function launchApplyModal() {
        
    const modal = UIkit.modal(document.getElementById('formSubmissionModal'));
    
        // Clear form fields
        document.getElementById('personalStatement').value = '';
        document.getElementById('cvFile').value = '';
        
        modal.show();
    }

document.getElementById('applicationForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    const scholarshipId = document.getElementById('scholarshipId').value;
    await submitApplication(scholarshipId);
});

function launchEditProfileModal() {
    const modal = UIkit.modal(document.getElementById('editProfileModal'));
    modal.show();
}

function submitApplication_test() {
    // Close modal and clear form fields
    UIkit.modal(document.getElementById('formSubmissionModal')).hide();
    document.getElementById('personalStatement').value = '';
    document.getElementById('cvFile').value = '';

    const scholarshipId = selected_ID;
    const scholarship = document.querySelector(`[id="${scholarshipId}"]`);

    if (scholarship) {
        const scholarshipData = {
            name: scholarship.getAttribute('data-name'),
            dueDate: new Date(scholarship.getAttribute('data-dueDate')),
            funderName: scholarship.getAttribute('data-funderName'),
            description: scholarship.getAttribute('data-description'),
            fundsAllocated: parseFloat(scholarship.getAttribute('data-fundsAllocated')),
            fundingType: scholarship.getAttribute('data-fundingType'),
            numOfApps: parseInt(scholarship.getAttribute('data-numOfApps')),
            creationDate: new Date(scholarship.getAttribute('data-creationDate')),
            endDate: new Date(scholarship.getAttribute('data-endDate')),
            requirements: scholarship.getAttribute('data-requirements')
        };

        // Ensure all tippy instances are properly removed
        if (scholarship._tippy) {
            scholarship._tippy.destroy();
            delete scholarship._tippy;
        }

        // Remove the element from the DOM
        scholarship.remove();

        // Recreate the scholarship in "myScholarships"
        writeScholarship(
            scholarshipData.name,
            scholarshipData.dueDate,
            scholarshipData.funderName,
            scholarshipData.description,
            scholarshipData.fundsAllocated,
            scholarshipData.fundingType,
            scholarshipData.numOfApps,
            scholarshipData.creationDate,
            scholarshipData.endDate,
            scholarshipData.requirements,
            'myScholarships'
        );

        // Find the newly added scholarship in "myScholarships"
        setTimeout(() => {
            const newScholarship = document.querySelector(`#myScholarshipsInner .scholarship:last-child`);
            if (newScholarship) {
                // Remove any lingering tippy instance before applying a new one
                if (newScholarship._tippy) {
                    newScholarship._tippy.destroy();
                    delete newScholarship._tippy;
                }

                console.log(newScholarship.getAttribute('data-tippy-content'));

                newScholarship.setAttribute('data-tippy-content', "");


                var scholarship = scholarshipData;
    var fundsAllocated = scholarshipData.fundsAllocated;
    var dueDate = new Date(scholarship.endDate);
    var creationDate = new Date(scholarship.creationDate);
    var randomID = "id_" + Math.floor(Math.random() * 1000000);
    const fixedDateMonth = dueDate.getMonth() + 1;
    const fixedDateDay = dueDate.getDate();
    const fixedDateYear = dueDate.getFullYear();

    // Generate tooltip content
    const today = new Date();
    const timeDiff = dueDate.getTime() - today.getTime();
    const daysUntilDeadline = Math.ceil(timeDiff / (1000 * 3600 * 24));

    const postedDateMonth = creationDate.getMonth() + 1;
    const postedDateDay = creationDate.getDate();
    const postedDateYear = creationDate.getFullYear();

    // how many days ago was creation date
    var timeDiff2 = today.getTime() - creationDate.getTime();
    var daysSincePosted = Math.ceil(timeDiff2 / (1000 * 3600 * 24));

    // if it was "1 days ago" change to "yesterday"
    if (daysSincePosted === 1) {
        daysSincePosted = 'Posted yesterday';
    } else {
        daysSincePosted = daysSincePosted + ' days ago';
    }

    var formattedMoney = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
    }).format(fundsAllocated);

    var dueDate = new Date(scholarship.endDate);
    var creationDate = new Date(scholarship.creationDate);

                var tooltipContent2 =  `
                            <p>Full Description</p>
            <h3>${scholarship.description}</h3>
            <hr>
            <p style = 'margin-top:10px' >Full Requirements</p>
            <h3>${scholarship.requirements}</h3>
            <hr>
            <p>Quick Info</p>
            <b style = 'opacity:30%' ><i class='ri-price-tag-3-fill'></i></b> <span style = 'opacity:30%'>${scholarship.name}</span><br>
            <b style = 'opacity:30%' ><i class='ri-hand-coin-fill'></i></b> <span style = 'opacity:30%' >${scholarship.funderName}</span><br>
            <b><i class='ri-money-dollar-circle-line'></i></b> <span>${formattedMoney}<span><br>
            <b><i class='ri-award-line'></i></b> <span>${scholarship.fundingType}</span><br>
            <b><i class='ri-calendar-check-line'></i></b> <span>${postedDateMonth}/${postedDateDay}/${postedDateYear}<span> <span class = 'daysLeft'> ${daysSincePosted}</span><br>
            <b><i class='ri-calendar-schedule-line'></i></b> <span>${fixedDateMonth}/${fixedDateDay}/${fixedDateYear}<span> <span class = 'daysLeft'> ${daysUntilDeadline} days left</span><br>
            <hr style = 'margin-top:10px;margin-bottom:10px'>
            <div class = "applicationStatus">
            <i class='ri-check-line'></i> <span>Submitted, Under Review</span>
            </div>
            `;

            newScholarship.setAttribute('data-tippy-content', tooltipContent2);


                tippy(newScholarship, {
                    allowHTML: true,
                    theme: 'innerMenuTheme',
                    interactive: true,
                    placement: 'right-start',
                    inertia: true,
                    content: tooltipContent2
                });

            }
        }, 0); // Timeout ensures DOM updates are processed before applying tippy
    }
}

var selected_ID = "";

</script>
<!--<script src="assets/js/dashboard.js"></script>-->

    </html>